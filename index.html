<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Studio - AI-First IDE</title>
    
    <!-- æ ·å¼ -->
    <link rel="stylesheet" href="src/ui/styles/main.css">
    
    <!-- Monaco Editor -->
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="node_modules/monaco-editor/min/vs/editor/editor.main.css">
    
    <!-- xterm.js -->
    <link rel="stylesheet" href="node_modules/xterm/css/xterm.css">
</head>
<body>
    <!-- é¡¶éƒ¨æ  -->
    <div class="top-bar">
        <div class="nav-buttons">
            <button class="nav-btn" title="åé€€">â†</button>
            <button class="nav-btn" title="å‰è¿›">â†’</button>
        </div>
        <div class="search-box">
            <span class="search-icon">ğŸ”</span>
            <input type="text" class="search-input" placeholder="æœç´¢æ–‡ä»¶ (Cmd+P)" id="quick-search">
        </div>
        <div class="top-actions">
            <button class="nav-btn" id="toggle-ai-btn" title="AI åŠ©æ‰‹ (Cmd+Shift+L)" style="font-size: 18px;">ğŸ¤–</button>
            <button class="nav-btn" id="toggle-terminal" title="åˆ‡æ¢ç»ˆç«¯ (Cmd+`)">âŒ˜</button>
            <button class="nav-btn" id="toggle-sidebar" title="åˆ‡æ¢ä¾§è¾¹æ ">ğŸ“</button>
            <button class="nav-btn" id="workspace-state-btn" title="å·¥ä½œåŒºçŠ¶æ€ç®¡ç†">ğŸ’¾</button>
            <button class="nav-btn" title="è®¾ç½®">âš™ï¸</button>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="main-container">
        <!-- å·¦ä¾§è¾¹æ  - æ–‡ä»¶æ ‘ -->
        <div class="sidebar">
            <div class="sidebar-header">
                <span>èµ„æºç®¡ç†å™¨</span>
                <div class="sidebar-actions">
                    <button class="sidebar-btn" title="æ–°å»ºæ–‡ä»¶" id="new-file-btn">ğŸ“„</button>
                    <button class="sidebar-btn" title="æ–°å»ºæ–‡ä»¶å¤¹" id="new-folder-btn">ğŸ“</button>
                    <button class="sidebar-btn" title="æ‰“å¼€é¡¹ç›®" id="open-project-btn">ğŸ“‚</button>
                    <button class="sidebar-btn" title="åˆ·æ–°" id="refresh-files-btn">ğŸ”„</button>
                </div>
            </div>
            <div id="file-tree">
                <!-- æ–‡ä»¶æ ‘å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                <div style="padding: 20px; text-align: center; color: var(--text-dim);">
                    <p style="margin-bottom: 12px; font-size: 16px;">ğŸ“‚</p>
                    <p style="font-size: 11px;">ç‚¹å‡»"æ‰“å¼€é¡¹ç›®"å¼€å§‹</p>
                </div>
            </div>
        </div>

        <!-- åˆ†éš”æ¡ï¼šå·¦ä¾§è¾¹æ  | ç¼–è¾‘å™¨ -->
        <div class="resizer" id="sidebar-resizer"></div>

        <!-- ä¸­é—´ - ç¼–è¾‘å™¨åŒºåŸŸ -->
        <div class="editor-area">
            <!-- æ ‡ç­¾æ  -->
            <div class="tabs-bar" id="tabs-bar">
                <!-- æ ‡ç­¾é¡µå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <!-- é¢åŒ…å±‘è·¯å¾„ -->
            <div class="breadcrumb-bar" id="breadcrumb-bar">
                <!-- é¢åŒ…å±‘å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <div class="editor-stack">
                <div class="editor-surface">
                    <!-- Monaco Editor å®¹å™¨ -->
                    <div id="editor-container"></div>
                </div>

                <div class="horizontal-resizer" id="terminal-resizer"></div>

                <!-- ç»ˆç«¯é¢æ¿ -->
                <div class="terminal-panel">
                    <div class="terminal-header">
                        <div class="terminal-title">ç»ˆç«¯</div>
                        <div class="sidebar-actions">
                            <button class="sidebar-btn" title="æ–°å»ºç»ˆç«¯">â•</button>
                            <button class="sidebar-btn" title="åˆ†å‰²ç»ˆç«¯">â«¿</button>
                            <button class="sidebar-btn" title="æ¸…å±">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    <div id="terminal-container"></div>
                </div>
            </div>
        </div>

        <!-- åˆ†éš”æ¡ï¼šç¼–è¾‘å™¨ | AI é¢æ¿ -->
        <div class="resizer hidden" id="ai-resizer"></div>

        <!-- å³ä¾§ - AI å¯¹è¯é¢æ¿ï¼ˆé»˜è®¤éšè—ï¼‰-->
        <div class="ai-panel hidden">
            <div class="ai-header">
                <div class="ai-title">
                    <span>ğŸ¤–</span>
                    <span>AI åŠ©æ‰‹</span>
                    <span class="claude-status status-disconnected" style="margin-left: 8px; font-size: 12px;">â— è¿æ¥ä¸­...</span>
                </div>
                <div class="ai-header-actions">
                    <button class="sidebar-btn" title="å¯¹è¯å†å²" id="history-btn">ğŸ“š</button>
                    <button class="sidebar-btn" title="ä¼šè¯ç®¡ç†" id="sessions-btn">ğŸ“‹</button>
                    <button class="sidebar-btn" title="ç³»ç»Ÿæç¤º" id="prompt-settings-btn">ğŸ¯</button>
                    <button class="sidebar-btn" title="æ¨¡å‹é€‰æ‹©" id="model-select-btn">âš™ï¸</button>
                    <button class="sidebar-btn" title="å…³é—­" id="close-ai-panel">Ã—</button>
                </div>
            </div>

            <!-- MVP-1.2: ä¼šè¯åˆ—è¡¨é¢æ¿ -->
            <div id="session-list-panel" class="session-list-panel" style="display: none; position: absolute; top: 40px; left: 0; right: 0; bottom: 0; background: white; z-index: 100; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
                <div id="session-list-content" style="height: 100%; overflow-y: auto;"></div>
            </div>

            <!-- AI Chat å®¹å™¨ - ç”± AIChatComponent å®Œå…¨æ§åˆ¶ -->
            <div id="aiChatContainer" style="display: flex; flex-direction: column; height: 100%; width: 100%;"></div>
        </div>

        <!-- æœç´¢é¢æ¿ -->
        <div id="search-panel" class="search-panel-container" style="display: none;">
            <!-- æœç´¢å·¥å…·æ  -->
            <div class="search-toolbar">
                <div class="search-input-group">
                    <input 
                        type="text" 
                        id="searchInput" 
                        class="search-input-field" 
                        placeholder="æœç´¢..."
                        autofocus
                    />
                    <button class="search-btn" id="searchBtn" title="æœç´¢">ğŸ”</button>
                    <button class="search-close-btn" id="searchCloseBtn" title="å…³é—­æœç´¢">âœ•</button>
                </div>
            </div>

            <!-- æœç´¢é€‰é¡¹ -->
            <div class="search-options">
                <label class="search-option">
                    <input type="checkbox" id="caseSensitive" />
                    <span>åŒºåˆ†å¤§å°å†™</span>
                </label>
                <label class="search-option">
                    <input type="checkbox" id="wholeWord" />
                    <span>å…¨å­—åŒ¹é…</span>
                </label>
                <label class="search-option">
                    <input type="checkbox" id="useRegex" />
                    <span>æ­£åˆ™è¡¨è¾¾å¼</span>
                </label>
            </div>

            <!-- æœç´¢ç»“æœå®¹å™¨ -->
            <div class="search-results-container">
                <div class="search-results-header">
                    <span id="searchResultsCount">0 ä¸ªç»“æœ</span>
                    <div class="search-navigation">
                        <button id="prevResultBtn">â¬†</button>
                        <button id="nextResultBtn">â¬‡</button>
                    </div>
                </div>
                <div class="search-results" id="searchResults">
                    <div class="no-results">è¾“å…¥æœç´¢è¯å¼€å§‹æœç´¢</div>
                </div>
            </div>

            <!-- æ›¿æ¢éƒ¨åˆ† (éšè—) -->
            <div class="search-replace-section" style="display: none;">
                <input 
                    type="text" 
                    id="replaceInput" 
                    class="search-input-field" 
                    placeholder="æ›¿æ¢ä¸º..."
                />
                <div class="search-replace-buttons">
                    <button class="search-btn" id="replaceBtn">æ›¿æ¢</button>
                    <button class="search-btn" id="replaceAllBtn">å…¨éƒ¨æ›¿æ¢</button>
                </div>
            </div>
        </div>

        <!-- æ£€æŸ¥ç‚¹é¢æ¿ (Phase 4) -->
        <div id="checkpoint-panel" class="checkpoint-panel" style="display: none; position: fixed; right: 20px; top: 60px; bottom: 60px; width: 400px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); overflow: hidden;">
            <!-- æ£€æŸ¥ç‚¹é¢æ¿å†…å®¹ç”± CheckpointPanelComponent æ¸²æŸ“ -->
        </div>
    </div>

    <!-- çŠ¶æ€æ  -->
    <div class="status-bar">
        <div class="status-item">
            <span>â—</span>
            <span id="status-branch">main</span>
        </div>
        <div class="status-item">
            <span>ğŸ“</span>
            <span id="status-project">æœªæ‰“å¼€é¡¹ç›®</span>
        </div>
        <div class="status-item" style="margin-left: auto;">
            <span id="status-position">Ln 1, Col 1</span>
        </div>
        <div class="status-item">
            <span id="status-language">Plain Text</span>
        </div>
        <div class="status-item">
            <span id="status-encoding">UTF-8</span>
        </div>
    </div>

    <!-- xterm CSS -->
    <link rel="stylesheet" href="node_modules/xterm/css/xterm.css">
    
    <!-- Monaco Editor åŠ è½½å™¨ -->
    <script>
        var require = { paths: { vs: 'node_modules/monaco-editor/min/vs' } };
    </script>
    <script src="node_modules/monaco-editor/min/vs/loader.js"></script>
    
    <!-- å…ˆåŠ è½½ Markdown åº“ -->
    <script src="src/utils/initMarkdownLibraries.js"></script>
    
    <!-- åŠ è½½ xterm.jsï¼ˆè§£å†³ AMD å†²çªï¼‰ -->
    <script>
        (function() {
            var savedRequire = window.require;
            var savedDefine = window.define;
            
            // æ‹¦æˆª AMD define è°ƒç”¨å¹¶è½¬æ¢ä¸ºå…¨å±€å˜é‡
            window.define = function() {
                var factory = arguments[arguments.length - 1];
                if (typeof factory === 'function') {
                    try {
                        var module = factory();
                        if (module && module.Terminal) {
                            window.Terminal = module.Terminal;
                        } else if (module && module.FitAddon) {
                            window.FitAddon = module.FitAddon;
                        }
                    } catch (e) {
                        console.error('æ¨¡å—åŠ è½½å¤±è´¥:', e);
                    }
                }
            };
            window.define.amd = true;
            
            // åŠ è½½ xterm è„šæœ¬
            Promise.all([
                fetch('node_modules/xterm/lib/xterm.js').then(r => r.text()),
                fetch('node_modules/xterm-addon-fit/lib/xterm-addon-fit.js').then(r => r.text())
            ]).then(function(scripts) {
                try {
                    eval(scripts[0]);
                    eval(scripts[1]);
                } catch (e) {
                    console.error('xterm åŠ è½½å¤±è´¥:', e);
                }
                
                // æ¢å¤ AMD ç¯å¢ƒ
                window.require = savedRequire;
                window.define = savedDefine;
                
                // åŠ è½½æ‰€æœ‰ç»„ä»¶è„šæœ¬
                var componentsLoaded = 0;
                var componentsNeeded = 18;  // +2 for MessageBuilder å’Œ AttachmentProcessor (Phase 3)
                
                function checkAndLoadApp() {
                  componentsLoaded++;
                  console.log('âœ“ ç»„ä»¶åŠ è½½ä¸­... (' + componentsLoaded + '/' + componentsNeeded + ')');
                  
                  if (componentsLoaded === componentsNeeded) {
                        // æ‰€æœ‰ç»„ä»¶åŠ è½½å®Œæˆï¼ŒåŠ è½½ app.js
                        console.log('âœ“ æ‰€æœ‰ç»„ä»¶åŠ è½½å®Œæˆï¼Œå¯åŠ¨åº”ç”¨...');
                        // ä½¿ç”¨ setTimeout ç¡®ä¿ DOM å·²å®Œå…¨åŠ è½½
                        setTimeout(function() {
                            var script = document.createElement('script');
                            script.src = 'src/renderer/app.js';
                            script.onload = function() {
                                console.log('âœ“ app.js åŠ è½½æˆåŠŸ');
                                console.log('âœ“ åº”ç”¨å¯åŠ¨å®Œæˆï¼');
                                if (window.studio) {
                                    console.log('âœ“ Studio å®ä¾‹å·²åˆå§‹åŒ–');
                                }
                            };
                            script.onerror = function() {
                                console.error('âŒ åŠ è½½ src/renderer/app.js å¤±è´¥');
                            };
                            document.body.appendChild(script);
                        }, 100);
                    }
                }
                
                function loadComponentWithErrorHandling(src, name) {
                    var script = document.createElement('script');
                    script.src = src;
                    script.onload = function() {
                        console.log('âœ“ åŠ è½½æˆåŠŸ:', name);
                        checkAndLoadApp();
                    };
                    script.onerror = function() {
                        console.error('âŒ åŠ è½½å¤±è´¥:', name, '(', src, ')');
                        checkAndLoadApp();
                    };
                    document.body.appendChild(script);
                }
                
                // å…ˆåŠ è½½å­˜å‚¨ç®¡ç†å™¨å’Œ Markdown æ¸²æŸ“å™¨
                loadComponentWithErrorHandling('src/modules/storage/IndexedDBManager.js', 'IndexedDBManager');
                loadComponentWithErrorHandling('src/utils/MarkdownRenderer.js', 'MarkdownRenderer');
                
                // åŠ è½½ç»„ä»¶ï¼Œå¸¦é”™è¯¯å¤„ç†
                loadComponentWithErrorHandling('src/components/MonacoEditor.js', 'MonacoEditor');
                loadComponentWithErrorHandling('src/components/AIChatComponent.js', 'AIChatComponent');
                loadComponentWithErrorHandling('src/components/SessionListComponent.js', 'SessionListComponent');
                loadComponentWithErrorHandling('src/components/CheckpointPanelComponent.js', 'CheckpointPanelComponent');
                loadComponentWithErrorHandling('src/components/TabContextMenu.js', 'TabContextMenu');
                
                // åŠ è½½ Managers å’Œ Dialogsï¼Œå¸¦é”™è¯¯å¤„ç†
                var exportImportScript = document.createElement('script');
                exportImportScript.src = 'src/modules/ai/SessionExportImportManager.js';
                exportImportScript.onload = function() {
                    console.log('âœ“ åŠ è½½æˆåŠŸ: SessionExportImportManager');
                    if (typeof SessionExportImportManager !== 'undefined') {
                        window.sessionExportImportManager = new SessionExportImportManager();
                    }
                    checkAndLoadApp();
                };
                exportImportScript.onerror = function() {
                    console.error('âŒ åŠ è½½å¤±è´¥: SessionExportImportManager');
                    checkAndLoadApp();
                };
                document.body.appendChild(exportImportScript);

                var promptManagerScript = document.createElement('script');
                promptManagerScript.src = 'src/modules/ai/SystemPromptManager.js';
                promptManagerScript.onload = function() {
                    console.log('âœ“ åŠ è½½æˆåŠŸ: SystemPromptManager');
                    if (typeof SystemPromptManager !== 'undefined') {
                        window.systemPromptManager = new SystemPromptManager();
                    }
                    checkAndLoadApp();
                };
                promptManagerScript.onerror = function() {
                    console.error('âŒ åŠ è½½å¤±è´¥: SystemPromptManager');
                    checkAndLoadApp();
                };
                document.body.appendChild(promptManagerScript);

                loadComponentWithErrorHandling('src/components/SystemPromptDialog.js', 'SystemPromptDialog');
                
                // åŠ è½½æ£€æŸ¥ç‚¹ç®¡ç†å™¨ (Phase 4)
                var checkpointManagerScript = document.createElement('script');
                checkpointManagerScript.src = 'src/modules/editor/CheckpointManager.js';
                checkpointManagerScript.onload = function() {
                    console.log('âœ“ åŠ è½½æˆåŠŸ: CheckpointManager');
                    if (typeof CheckpointManager !== 'undefined') {
                        window.checkpointManager = new CheckpointManager();
                    }
                    checkAndLoadApp();
                };
                checkpointManagerScript.onerror = function() {
                    console.error('âŒ åŠ è½½å¤±è´¥: CheckpointManager');
                    checkAndLoadApp();
                };
                document.body.appendChild(checkpointManagerScript);
                
                var templateLibScript = document.createElement('script');
                templateLibScript.src = 'src/modules/ai/PromptTemplateLibrary.js';
                templateLibScript.onload = function() {
                    console.log('âœ“ åŠ è½½æˆåŠŸ: PromptTemplateLibrary');
                    if (typeof PromptTemplateLibrary !== 'undefined') {
                        window.promptTemplateLibrary = new PromptTemplateLibrary();
                    }
                    checkAndLoadApp();
                };
                templateLibScript.onerror = function() {
                    console.error('âŒ åŠ è½½å¤±è´¥: PromptTemplateLibrary');
                    checkAndLoadApp();
                };
                document.body.appendChild(templateLibScript);

                loadComponentWithErrorHandling('src/components/PromptTemplateDialog.js', 'PromptTemplateDialog');

                // Phase 3: åŠ è½½å‘½ä»¤ç³»ç»Ÿè„šæœ¬
                loadComponentWithErrorHandling('src/modules/ai/CommandParser.js', 'CommandParser');
                loadComponentWithErrorHandling('src/modules/ai/CommandRegistry.js', 'CommandRegistry');
                loadComponentWithErrorHandling('src/modules/ai/CommandExecutor.js', 'CommandExecutor');

                // Phase 3-4: åŠ è½½é™„ä»¶ç®¡ç†ç³»ç»Ÿå’Œ API é›†æˆ
                loadComponentWithErrorHandling('src/modules/attachments/FileValidator.js', 'FileValidator');
                loadComponentWithErrorHandling('src/modules/attachments/AttachmentManager.js', 'AttachmentManager');
                
                // Phase 3: åŠ è½½ Claude API é›†æˆæ¨¡å—
                loadComponentWithErrorHandling('src/modules/ai/MessageBuilder.js', 'MessageBuilder');
                loadComponentWithErrorHandling('src/modules/attachments/AttachmentProcessor.js', 'AttachmentProcessor');

                // åŠ è½½æœç´¢ç»„ä»¶
                var searchScript = document.createElement('script');
                searchScript.src = 'src/components/SearchComponent.js';
                searchScript.onload = function() {
                    console.log('âœ“ åŠ è½½æˆåŠŸ: SearchComponent');
                    if (typeof SearchComponent !== 'undefined') {
                        window.searchComponent = new SearchComponent();
                    }
                    checkAndLoadApp();
                };
                searchScript.onerror = function() {
                    console.error('âŒ åŠ è½½å¤±è´¥: SearchComponent');
                    checkAndLoadApp();
                };
                document.body.appendChild(searchScript);
            }).catch(function(err) {
                console.error('åŠ è½½å¤±è´¥:', err);
            });
        })();
    </script>
</body>
</html>
